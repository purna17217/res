The method alpha cannot be declared static; static methods can only be declared in a static or top level type

@Override
public String toString() {
    return new StringBuilder()
        .append(CobolFormatter.alpha(rdFlag, 1))                 // PIC X(001)
        .append(CobolFormatter.alpha(acctDesc, 1))               // PIC X(001)
        .append(CobolFormatter.numeric(dteLastChg, 9))           // PIC S9(09) COMP
        .append(CobolFormatter.alpha(status, 1))                 // PIC X(001)
        .append(CobolFormatter.numeric(closeDt, 9))              // PIC S9(09) COMP
        .append(CobolFormatter.alpha(instLFreq, 1))              // PIC X(001)
        .append(CobolFormatter.numeric(instlMltplAmt, 17))       // S9(14)V9(03)
        .append(CobolFormatter.alpha(minOpenBal, 3))             // PIC X(003)
        .append(CobolFormatter.numeric(maxOpenBal, 17))          // S9(14)V9(03)
        .append(CobolFormatter.alpha(termDays, 4))               // PIC X(004)
        .append(CobolFormatter.alpha(termDaysMax, 4))            // PIC X(004)
        .append(CobolFormatter.alpha(termBasis, 1))              // PIC X(001)
        .append(CobolFormatter.alpha(termIntFrequency, 3))       // PIC X(003)
        .append(CobolFormatter.alpha(termIntMethod, 1))          // PIC X(001)
        .append(CobolFormatter.alpha(termFixDtInt, 1))           // PIC X(001)
        .append(CobolFormatter.alpha(InstalFlag, 1))             // PIC X(001)
        .append(CobolFormatter.alpha(ReinvInt, 1))               // PIC X(001)
        .append(CobolFormatter.alpha(annivDating, 1))            // PIC X(001)
        .append(CobolFormatter.alpha(diviFlag, 1))               // PIC X(001)
        .append(CobolFormatter.alpha(intCat, 4))                 // PIC X(004)
        .append(CobolFormatter.numeric(crIntDaysYr, 3))          // PIC S9(03) COMP
        .append(CobolFormatter.numeric(calendarCode, 2))         // PIC S9(02) COMP
        .append(CobolFormatter.alpha(goldFlag, 1))               // PIC X(001)
        .append(CobolFormatter.alpha(termIntCompFreq, 3))        // PIC X(003)
        .append(CobolFormatter.alpha(monBaseInt, 1))             // PIC X(001)
        .append(CobolFormatter.numeric(CrCompEodDt, 9))          // PIC S9(09) COMP
        .append(CobolFormatter.alpha(minCompPrdBasis, 1))        // PIC X(001)
        .append(CobolFormatter.alpha(termMinCompPrd, 4))         // PIC X(004)
        .append(CobolFormatter.alpha(intRndPrcs, 1))             // PIC X(001)
        .append(CobolFormatter.alpha(intRndRule, 4))             // PIC X(004)
        .append(CobolFormatter.alpha(intRndMethod, 1))           // PIC X(001)
        .append(CobolFormatter.alpha(salbId, 2))                 // PIC X(002)
        .append(CobolFormatter.alpha(cofmFlag, 1))               // PIC X(001)
        .append(CobolFormatter.alpha(curacDbaseId, 4))           // PIC X(004)
        .append(CobolFormatter.alpha(curacDrateId, 4))           // PIC X(004)
        .append(CobolFormatter.alpha(curacDtierId, 4))           // PIC X(004)
        .append(CobolFormatter.alpha(varRateFlag, 1))            // PIC X(001)
        .append(CobolFormatter.alpha(currency, 3))               // PIC X(003)
        .append(CobolFormatter.alpha(tomRateTblId, 4))           // PIC X(004)
        .toString();
}


public final class CobolFormatter {

    private CobolFormatter() {}

    // For PIC X(...)
    public static String alpha(String value, int length) {
        if (value == null) value = "";
        if (value.length() > length) return value.substring(0, length);
        return String.format("%-" + length + "s", value);
    }

    // For PIC 9 / S9 / COMP (treated as numeric string)
    public static String numeric(String value, int length) {
        if (value == null || value.trim().isEmpty()) value = "0";
        value = value.replaceAll("\\D", ""); // safety
        if (value.length() > length) return value.substring(value.length() - length);
        return String.format("%0" + length + "d", Long.parseLong(value));
    }
}







package com.tcs.bancs.microservices.db.model;

import java.io.Serializable;

import javax.persistence.Column;
import javax.persistence.EmbeddedId;
import javax.persistence.Entity;


	
	@Entity
	public class Depp extends BaseModel implements Serializable {
		private static final long serialVersionUID = 1L;
		 
		@EmbeddedId
		private Depppk depppk ;
		
		
		@Column(name="RD_FLAG")
		private String rdFlag;

		@Column(name="ACCT_DESC")
		private String acctDesc;
		
		@Column(name="DTE_LAST_CHG")
		private String dteLastChg;
		
		@Column(name="STATUS")
		private String status;
		
		@Column(name="CLOSE_DT")
		private String closeDt;
		
		@Column(name="INSTL_FREQ")
		private String instLFreq;
		
		@Column(name="INSTL_MLTPL_AMT")
		private String instlMltplAmt;
		
		@Column(name="MIN_OPEN_BAL")
		private String minOpenBal;
		
		@Column(name="MAX_OPEN_BAL")
		private String maxOpenBal;
		
		@Column(name="TERM_DAYS")
		private String termDays;
		
		@Column(name="TERM_DAYS_MAX")
		private String termDaysMax;
		
		@Column(name="TERM_BASIS")
		private String termBasis ;
		
		@Column(name="TERM_INT_FREQUENCY")
		private String termIntFrequency;
		
		@Column(name="TERM_INT_METHOD")
		private String termIntMethod;
		
		@Column(name="TERM_FIX_DT_INT")
		private String termFixDtInt;
		
		@Column(name="INSTAL_FLAG")
		private String InstalFlag;
				
		@Column(name="REINV_INT")
		private String ReinvInt;
		
		@Column(name="ANNIV_DATING")
		private String annivDating;
		
		@Column(name="DIVI_FLAG")
		private String diviFlag;
		
		@Column(name="INT_CAT")
		private String intCat;
		
		@Column(name="CR_INT_DAYS_YR")
		private String crIntDaysYr;
		
		@Column(name="CALENDAR_CODE")
		private String calendarCode;
		
		@Column(name="GOLD_FLAG")
		private String goldFlag;
				
		@Column(name="TERM_INT_COMP_FREQ")
		private String termIntCompFreq;
		
		@Column(name="MON_BASE_INT")
		private String monBaseInt;
		
		@Column(name="CR_COMP_EOP_DT")
		private String CrCompEodDt;
		
		@Column(name="MIN_COMP_PRD_BASIS")
		private String minCompPrdBasis;
		
		@Column(name="TERM_MIN_COMP_PRD")
		private String termMinCompPrd;
		
		@Column(name="INT_RND_PRCS")
		private String intRndPrcs;
		
		@Column(name="INT_RND_RULE")
		private String intRndRule;
		
		@Column(name="INT_RND_METHOD")
		private String intRndMethod;
		
		@Column(name="SLAB_ID")
		private String salbId;
		
		@Column(name="LOCK_IN_FLAG")
		private String lockInFlag;
		
		@Column(name="CURAC_DBASE_ID")
		private String curacDbaseId;
		
		@Column(name="CURAC_DRATE_ID")
		private String curacDrateId;
		
		@Column(name="CURAC_DTIER_ID")
		private String curacDtierId;
		
		@Column(name="VAR_RATE_FLAG")
		private String varRateFlag;
		
		@Column(name="CURRENCY")
		private String currency;
		
		@Column(name="COFM_FLAG")
		private String cofmFlag;
		
		@Column(name="TOM_RATE_TBL_ID")
		private String tomRateTblId;

		public Depppk getDepppk() {
			return depppk;
		}

		public void setDepppk(Depppk depppk) {
			this.depppk = depppk;
		}

		public String getRdFlag() {
			return rdFlag;
		}

		public void setRdFlag(String rdFlag) {
			this.rdFlag = rdFlag;
		}

		public String getAcctDesc() {
			return acctDesc;
		}

		public void setAcctDesc(String acctDesc) {
			this.acctDesc = acctDesc;
		}

		public String getDteLastChg() {
			return dteLastChg;
		}

		public void setDteLastChg(String dteLastChg) {
			this.dteLastChg = dteLastChg;
		}

		public String getStatus() {
			return status;
		}

		public void setStatus(String status) {
			this.status = status;
		}

		public String getCloseDt() {
			return closeDt;
		}

		public void setCloseDt(String closeDt) {
			this.closeDt = closeDt;
		}

		public String getInstLFreq() {
			return instLFreq;
		}

		public void setInstLFreq(String instLFreq) {
			this.instLFreq = instLFreq;
		}

		public String getInstlMltplAmt() {
			return instlMltplAmt;
		}

		public void setInstlMltplAmt(String instlMltplAmt) {
			this.instlMltplAmt = instlMltplAmt;
		}

		public String getMinOpenBal() {
			return minOpenBal;
		}

		public void setMinOpenBal(String minOpenBal) {
			this.minOpenBal = minOpenBal;
		}

		public String getMaxOpenBal() {
			return maxOpenBal;
		}

		public void setMaxOpenBal(String maxOpenBal) {
			this.maxOpenBal = maxOpenBal;
		}

		public String getTermDays() {
			return termDays;
		}

		public void setTermDays(String termDays) {
			this.termDays = termDays;
		}

		public String getTermDaysMax() {
			return termDaysMax;
		}

		public void setTermDaysMax(String termDaysMax) {
			this.termDaysMax = termDaysMax;
		}

		public String getTermBasis() {
			return termBasis;
		}

		public void setTermBasis(String termBasis) {
			this.termBasis = termBasis;
		}

		public String getTermIntFrequency() {
			return termIntFrequency;
		}

		public void setTermIntFrequency(String termIntFrequency) {
			this.termIntFrequency = termIntFrequency;
		}

		public String getTermIntMethod() {
			return termIntMethod;
		}

		public void setTermIntMethod(String termIntMethod) {
			this.termIntMethod = termIntMethod;
		}

		public String getTermFixDtInt() {
			return termFixDtInt;
		}

		public void setTermFixDtInt(String termFixDtInt) {
			this.termFixDtInt = termFixDtInt;
		}

		public String getInstalFlag() {
			return InstalFlag;
		}

		public void setInstalFlag(String instalFlag) {
			InstalFlag = instalFlag;
		}

		public String getReinvInt() {
			return ReinvInt;
		}

		public void setReinvInt(String reinvInt) {
			ReinvInt = reinvInt;
		}

		public String getAnnivDating() {
			return annivDating;
		}

		public void setAnnivDating(String annivDating) {
			this.annivDating = annivDating;
		}

		public String getDiviFlag() {
			return diviFlag;
		}

		public void setDiviFlag(String diviFlag) {
			this.diviFlag = diviFlag;
		}

		public String getIntCat() {
			return intCat;
		}

		public void setIntCat(String intCat) {
			this.intCat = intCat;
		}

		public String getCrIntDaysYr() {
			return crIntDaysYr;
		}

		public void setCrIntDaysYr(String crIntDaysYr) {
			this.crIntDaysYr = crIntDaysYr;
		}

		public String getCalendarCode() {
			return calendarCode;
		}

		public void setCalendarCode(String calendarCode) {
			this.calendarCode = calendarCode;
		}

		public String getGoldFlag() {
			return goldFlag;
		}

		public void setGoldFlag(String goldFlag) {
			this.goldFlag = goldFlag;
		}

		public String getTermIntCompFreq() {
			return termIntCompFreq;
		}

		public void setTermIntCompFreq(String termIntCompFreq) {
			this.termIntCompFreq = termIntCompFreq;
		}

		public String getMonBaseInt() {
			return monBaseInt;
		}

		public void setMonBaseInt(String monBaseInt) {
			this.monBaseInt = monBaseInt;
		}

		public String getCrCompEodDt() {
			return CrCompEodDt;
		}

		public void setCrCompEodDt(String crCompEodDt) {
			CrCompEodDt = crCompEodDt;
		}

		public String getMinCompPrdBasis() {
			return minCompPrdBasis;
		}

		public void setMinCompPrdBasis(String minCompPrdBasis) {
			this.minCompPrdBasis = minCompPrdBasis;
		}

		public String getTermMinCompPrd() {
			return termMinCompPrd;
		}

		public void setTermMinCompPrd(String termMinCompPrd) {
			this.termMinCompPrd = termMinCompPrd;
		}

		public String getIntRndPrcs() {
			return intRndPrcs;
		}

		public void setIntRndPrcs(String intRndPrcs) {
			this.intRndPrcs = intRndPrcs;
		}

		public String getIntRndRule() {
			return intRndRule;
		}

		public void setIntRndRule(String intRndRule) {
			this.intRndRule = intRndRule;
		}

		public String getIntRndMethod() {
			return intRndMethod;
		}

		public void setIntRndMethod(String intRndMethod) {
			this.intRndMethod = intRndMethod;
		}

		public String getSalbId() {
			return salbId;
		}

		public void setSalbId(String salbId) {
			this.salbId = salbId;
		}

		public String getLockInFlag() {
			return lockInFlag;
		}

		public void setLockInFlag(String lockInFlag) {
			this.lockInFlag = lockInFlag;
		}

		public String getCuracDbaseId() {
			return curacDbaseId;
		}

		public void setCuracDbaseId(String curacDbaseId) {
			this.curacDbaseId = curacDbaseId;
		}

		public String getCuracDrateId() {
			return curacDrateId;
		}

		public void setCuracDrateId(String curacDrateId) {
			this.curacDrateId = curacDrateId;
		}

		public String getCuracDtierId() {
			return curacDtierId;
		}

		public void setCuracDtierId(String curacDtierId) {
			this.curacDtierId = curacDtierId;
		}

		public String getVarRateFlag() {
			return varRateFlag;
		}

		public void setVarRateFlag(String varRateFlag) {
			this.varRateFlag = varRateFlag;
		}

		public String getCurrency() {
			return currency;
		}

		public void setCurrency(String currency) {
			this.currency = currency;
		}

		public String getCofmFlag() {
			return cofmFlag;
		}

		public void setCofmFlag(String cofmFlag) {
			this.cofmFlag = cofmFlag;
		}

		public String getTomRateTblId() {
			return tomRateTblId;
		}

		public void setTomRateTblId(String tomRateTblId) {
			this.tomRateTblId = tomRateTblId;
		}

		@Override
		public String toString() {
			return String.join("",rdFlag,acctDesc,dteLastChg,status,closeDt,instLFreq,instlMltplAmt,minOpenBal,maxOpenBal,termDays,termDaysMax,termBasis,termIntFrequency,termIntMethod,termFixDtInt,InstalFlag,ReinvInt,annivDating,diviFlag,intCat,crIntDaysYr,calendarCode,goldFlag,termIntCompFreq,monBaseInt,CrCompEodDt,minCompPrdBasis,termMinCompPrd,intRndPrcs,intRndRule,intRndMethod,salbId,lockInFlag,curacDbaseId,curacDrateId,curacDtierId,varRateFlag,currency,cofmFlag,tomRateTblId );
		}
		
		
	
		
	}
	
	
	
	
	
	  03  D-RD-FLAG                     PIC X(001) .
    03  D-ACCT-DESC                   PIC X(001) .
    03  D-DTE-LAST-CHG                PIC S9(09) COMP.
    03  D-STATUS                      PIC X(001) .
    03  D-CLOSE-DT                    PIC S9(09) COMP.
    03  D-INSTL-FREQ                  PIC X(001) .
    03  D-INSTL-MLTPL-AMT             PIC S9(14)V9(03) COMP-3.
    03  D-MIN-OPEN-BAL-CUR            PIC X(003) .
    03  D-MAX-OPEN-BAL                PIC S9(14)V9(03) COMP-3.
    03  D-TERM-DAYS                   PIC X(004) .
    03  D-TERM-DAYS-MAX               PIC X(004) .
    03  D-TERM-BASIS                  PIC X(001) .
    03  D-TERM-INT-FREQUENCY          PIC X(003) .
    03  D-TERM-INT-METHOD             PIC X(001) .
    03  D-TERM-FIX-DT-INT             PIC X(001) .
      03  D-INSTAL-FLAG                 PIC X(001) .
      03  D-REINV-INT                   PIC X(001) .
      03  D-ANNIV-DATING                PIC X(001) .
      03  D-DIVI-FLAG                   PIC X(001) .
      03  D-SAVP-INT-CAT                PIC X(004) .
      03  D-CR-INT-DAYS-YR              PIC S9(03) COMP.
      03  D-CALENDAR-CODE               PIC S9(02) COMP.
      03  D-GOLD-FLAG                   PIC X(001) .
      03  D-TERM-INT-COMP-FREQ          PIC X(003) .
      03  D-MON-BASE-INT                PIC X(001) .
      03  D-CR-COMP-EOP-DT              PIC S9(09) COMP.
      03  D-MIN-COMP-PRD-BASIS          PIC X(001) .
      03  D-TERM-MIN-COMP-PRD           PIC X(004) .
      03  D-INT-RND-PRCS                PIC X(001) .
      03  D-INT-RND-RULE                PIC X(004) .
      03  D-INT-RND-METHOD              PIC X(001) .
    03  D-SLAB-ID                     PIC X(002) .
    03  D-COFM-FLAG                   PIC X(001) .
    03  D-CURAC-DBASE-ID              PIC X(004) .
      03  D-CURAC-DRATE-ID              PIC X(004) .
      03  D-CURAC-DTIER-ID              PIC X(004) .
    03  D-FIX-RATE-TERM-FLAG          PIC X(001) .
    03  D-CURRENCY                    PIC X(003) .
    03  D-COFM-FLAG                   PIC X(001) .
    03  D-TOM-RATE-TBL-ID             PIC X(004) .


























||getCustomerDetails|2026-02-02 13:12:37,096 ERROR com.tcs.bancs.microservices.services.MobileEnqServiceTest [http-nio-10.243.6.75-1002-exec-2] MOB-ENQUIRY-FAILURE | Ref=SBIES00000010050000000303
||getCustomerDetails|java.lang.NullPointerException: null
	at com.tcs.bancs.microservices.services.MobileEnqServiceTest.executeCobolCall(MobileEnqServiceTest.java:369)
	at com.tcs.bancs.microservices.services.MobileEnqServiceTest.callMOBEnquiryChild(MobileEnqServiceTest.java:250)
	at com.tcs.bancs.microservices.services.PFMOBEnquiryService.getCustomerDetails(PFMOBEnquiryService.java:624)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
	at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
	at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
	at java.base/java.lang.reflect.Method.invoke(Method.java:566)
	at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:190)
	at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:138)
	at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:105)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:878)
	at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:792)
	at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1040)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:943)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:909)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:652)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:733)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at com.tcs.bancs.microservices.interceptor.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:25)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:202)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:97)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:542)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:143)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:78)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:374)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1590)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.base/java.lang.Thread.run(Thread.java:834)












import java.math.BigInteger;
import java.sql.Connection;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Semaphore;
import java.util.concurrent.TimeUnit;

import javax.sql.DataSource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

public class MOBEnquiryService {

    private static final Logger logger = LoggerFactory.getLogger(MOBEnquiryService.class);

    /* ===================== SEMAPHORE CONFIG ===================== */
    private static final int MAX_CONCURRENT_CALLS = 20;
    private static final Semaphore DB_SEMAPHORE =
            new Semaphore(MAX_CONCURRENT_CALLS, true);

    private Properties custStatus;
    private String errno = "0000";

    /* ===================== ENTRY METHOD ===================== */
    public List<String> callMOBEnquiryChild(
            String refno,
            String branchno,
            String tellerno,
            String mobno,
            String cifno,
            int requestedNumberOfRecords,
            DataSource dataSource,
            String commonArea
    ) throws ExecutionException {

        boolean permitAcquired = false;
        long serviceStart = System.currentTimeMillis();

        try {
            /* ===================== SEMAPHORE ACQUIRE ===================== */
            if (!DB_SEMAPHORE.tryAcquire(5, TimeUnit.SECONDS)) {
                logger.error(
                        "DB-THROTTLE | Ref={} | ActivePermits={} | WaitingThreads={}",
                        refno,
                        MAX_CONCURRENT_CALLS - DB_SEMAPHORE.availablePermits(),
                        DB_SEMAPHORE.getQueueLength()
                );
                throw new RuntimeException("System busy. Please retry.");
            }

            permitAcquired = true;

            logger.info(
                    "DB-PERMIT-ACQUIRED | Ref={} | ActivePermits={}",
                    refno,
                    MAX_CONCURRENT_CALLS - DB_SEMAPHORE.availablePermits()
            );

            /* ===================== BUSINESS EXECUTION ===================== */
            return executeCobolCall(
                    refno,
                    branchno,
                    tellerno,
                    mobno,
                    cifno,
                    requestedNumberOfRecords,
                    dataSource,
                    commonArea,
                    serviceStart
            );

        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
            logger.error("THREAD-INTERRUPTED | Ref={}", refno, e);
            throw new RuntimeException("Request interrupted", e);

        } finally {
            if (permitAcquired) {
                DB_SEMAPHORE.release();
                logger.info(
                        "DB-PERMIT-RELEASED | Ref={} | ActivePermits={}",
                        refno,
                        MAX_CONCURRENT_CALLS - DB_SEMAPHORE.availablePermits()
                );
            }
        }
    }

    /* ===================== CORE DB + COBOL LOGIC ===================== */
    private List<String> executeCobolCall(
            String refno,
            String branchno,
            String tellerno,
            String mobno,
            String cifno,
            int requestedNumberOfRecords,
            DataSource dataSource,
            String commonArea,
            long serviceStart
    ) {

        List<String> arrResult = new ArrayList<>();
        StringBuilder allRecordsBuilder = new StringBuilder();
        int index = 0;
        String tempFlag = "N";

        String lacctno = (cifno == null)
                ? "00000000000000000"
                : String.format("%017d", new BigInteger(cifno));

        try (Connection connection = dataSource.getConnection();
             RunUnit run1 = new RunUnit()) {

            long connTime = System.currentTimeMillis() - serviceStart;

            if (connTime > 20) {
                logger.warn("SLOW-DB-CONN | Ref={} | TimeMs={}", refno, connTime);
            }

            logger.info(
                    "DB-CONN-ACQUIRED | Ref={} | Thread={} | ConnHash={}",
                    refno,
                    Thread.currentThread().getName(),
                    System.identityHashCode(connection)
            );

            /* ===================== COBOL INPUT ===================== */
            JVMSCPF jvmmob = new JVMSCPF();

            LsBranchNo mobinput1 = new LsBranchNo();
            LsTellerNo mobinput2 = new LsTellerNo();
            LsMobNumber mobinput3 = new LsMobNumber();
            LsCustomerNo mobinput4 = new LsCustomerNo();
            LsFunction mobinput5 = new LsFunction();
            LsRecordArea mobinput8 = new LsRecordArea();
            LsErrorNumber moboutput2 = new LsErrorNumber();

            mobinput1.setLsBranchNo(String.format("%016d", Integer.parseInt(branchno)));
            mobinput2.setLsTellerNo(tellerno);
            mobinput3.setLsMobNumber(mobno);
            mobinput4.setLsCustomerNo(lacctno);
            mobinput5.setLsFunction("M");
            mobinput8.setLsRecordArea(commonArea);

            run1.Add(jvmmob);

            /* ===================== COBOL CALL ===================== */
            long start = System.currentTimeMillis();

            logger.info("COBOL-START | Ref={}", refno);

            run1.Call(
                    "JVMSCPF",
                    mobinput1.get_Reference(),
                    mobinput2.get_Reference(),
                    mobinput3.get_Reference(),
                    mobinput4.get_Reference(),
                    mobinput5.get_Reference(),
                    moboutput2.get_Reference(),
                    mobinput8.get_Reference(),
                    arrResult,
                    connection
            );

            logger.info(
                    "COBOL-END | Ref={} | TimeMs={}",
                    refno,
                    System.currentTimeMillis() - start
            );

            /* ===================== RESPONSE PROCESSING ===================== */
            while (index < arrResult.size()) {
                String outPutRes = arrResult.get(index);
                if (outPutRes == null || outPutRes.trim().isEmpty()) {
                    break;
                }

                String lastThree = outPutRes.substring(77, 80);
                String custDesc = custStatus.getProperty(lastThree);
                custDesc = (custDesc == null) ? " ".repeat(100) : custDesc;

                allRecordsBuilder.append(outPutRes, 0, 83)
                                 .append(custDesc);

                index++;
            }

            tempFlag = "Y";

            logger.info(
                    "MOB-ENQUIRY-SUCCESS | Ref={} | Records={}",
                    refno, index
            );

        } catch (Exception e) {
            errno = "3293";
            logger.error("MOB-ENQUIRY-FAILURE | Ref={}", refno, e);
        }

        /* ===================== FINAL RESPONSE ===================== */
        List<String> res = new ArrayList<>();
        res.add(allRecordsBuilder.toString());
        res.add(String.valueOf(index));
        res.add("Y".equals(tempFlag) ? "0000" : errno);

        return res;
    }
}











//           SBI Core Banking Project, Hyderabad, India.          *
//*****************************************************************
//                                                                *
//  	           PROGRAM - PFMOBEnquiryService.Java                 
//                                                                *
//*****************************************************************
//                 P R O G R A M    H I S T O R Y                 *
//                                                                *
//   PROGRAMMER    :    DATE       :  SPR NO   :   COMMENTS       *
//----------------------------------------------------------------*
//Niharika Tammana : 15/10/2024    : 24090001  :  MICROSERVICES   *
//Naga Sai Ganesh  : 15/10/2024    : 24090001  :  MICROSERVICES   *
//Niharika Tammana : 24/01/2025    : 25010222  :  MICROSERVICES   *
//Purna Tirunagari: 01/10/2025    : 25100006  :  MICROSERVICES   *
//----------------------------------------------------------------*
//START OF IR 25100006
package com.tcs.bancs.microservices.services;

import java.math.BigInteger;
import java.sql.Connection;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;
import java.util.Properties;
import java.util.concurrent.*;
import javax.sql.DataSource;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.microfocus.cobol.runtimeservices.RunUnit;
import com.tcs.bancs.microservices.config.CacheConfig;
import com.tcs.bancs.microservices.configuration.PropertyLoader;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsBranchNo;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsCustomerNo;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsErrorNumber;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsFunction;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsMobNumber;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsRecordArea;
import com.tcs.bancs.microservices.jvm.scpf.JVMSCPF.LsTellerNo;
import com.tcs.bancs.microservices.util.FrameworkConstants;

public class MobileEnqServiceTest {
	
	Logger logger = LoggerFactory.getLogger(MobileEnqServiceTest.class);
	Connection connection;
	String errno = new String();
	String customerStatus = CacheConfig.frameworkConfigProperties.getProperty(FrameworkConstants.LOOKUP_FILES_PATH);
	Properties custStatus = PropertyLoader
			.readPropertyFile(new String(customerStatus + "/CustomerStatus.properties"));
	
	public List<String> callMOBEnquiryChild( String refno,String branchno, String tellerno, String mobno, String cifno, int requestedNumberOfRecords,DataSource dataSource,String commonArea) throws InterruptedException, ExecutionException {
		
		logger.info("VC------------------------MOB Enquiry Child Service Test Started WithOut ForkJoinPool------------------------VC "+refno);

		long serviceStart = System.currentTimeMillis();
		
		String lacctno = cifno == null ? "00000000000000000" : String.format("%017d", new BigInteger(cifno));
		
        int index = 0;       
        List<String>    arrResult		= new ArrayList<>();
        StringBuilder allRecordsBuilder = new StringBuilder();
   	    String tempFlag = "";
        try (Connection connection = dataSource.getConnection();RunUnit run1 = new RunUnit())
        {
        	
        	long connTime =System.currentTimeMillis()-serviceStart;
        	
        	if(connTime>20)
        	{
        		
        		/* ===================== SLOW DB CONNECTION ===================== */
        		logger.warn("SLOW-DB-CONN | Ref={} | TimeMs={} ",refno,connTime);
        	}
        	else
        	{
        		/* ===================== DB CONNECTION ACQUIRED ===================== */
                logger.info(
                        "DB-CONN-ACQUIRED | Ref={} | Thread={} | ConnHash={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection)
                );
        	}
        	
        	
        
                	
            
        	  	JVMSCPF         jvmmob      = new JVMSCPF();        	  	
            	LsBranchNo  	mobinput1	= new LsBranchNo();
            	LsTellerNo	    mobinput2	= new LsTellerNo();
                LsMobNumber 	mobinput3 	= new LsMobNumber();
                LsCustomerNo    mobinput4	= new LsCustomerNo();
                LsFunction	    mobinput5	= new LsFunction();			
                LsRecordArea    mobinput8   = new LsRecordArea();             
                LsErrorNumber   moboutput2 = new LsErrorNumber();;
                mobinput2.setLsTellerNo(tellerno);
                mobinput1.setLsBranchNo(String.format("%016d", Integer.parseInt(branchno)));  
                mobinput3.setLsMobNumber(mobno);
                mobinput4.setLsCustomerNo(lacctno);
                mobinput5.setLsFunction("M");
                mobinput8.setLsRecordArea(commonArea);
                
                
                

                run1.Add(jvmmob);
                
                /* ===================== COBOL START ===================== */
                long start = System.currentTimeMillis();
                logger.info(
                        "COBOL-START | Ref={} | AsyncThread={} | ConnHash={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection)
                );
                
             // Call the JVMSCPF service
                run1.Call("JVMSCPF", mobinput1.get_Reference(), mobinput2.get_Reference(), mobinput3.get_Reference(), mobinput4.get_Reference(),mobinput5.get_Reference(),
                		moboutput2.get_Reference(), mobinput8.get_Reference(),arrResult,connection );
                /* ===================== COBOL END ===================== */
                logger.info(
                        "COBOL-END | Ref={} | AsyncThread={} | ConnHash={} | TimeMs={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection),
                        System.currentTimeMillis() - start
                );
          
             int listCount = arrResult.size();
                
          
            	  while (index < listCount) {
                      
                    
            		  String outPutRes = arrResult.get(index);
                      if(outPutRes==null||outPutRes.trim().isEmpty())
                      {
                      	break;
                      }
                      String lastThree = outPutRes.substring(77,80);
                      String custDesc = custStatus.getProperty(lastThree);
                      custDesc = (custDesc==null) ? " ".repeat(100) : custDesc;
                      allRecordsBuilder.append(outPutRes.substring(0, 83)+custDesc);
                      index++;
                  }
           
              
               
            
        
       
        tempFlag = "Y";
        
        logger.info("VC------------------------Mobile Enquiry Service Test no of records fetched : " +index+" ------------------------VC " + refno);
    } 
        
        catch (Exception e)
        {
        	errno = "3293";
        	tempFlag = "N";
        	logger.info("VC------------------------Exception Occured at MOB Enquiry Child Service Test ------------------------VC " + " " + e + " at  " +refno);
        } 

        List<String> res = new ArrayList<>();
        res.add(allRecordsBuilder.toString()); 
        res.add(String.valueOf(index)); 
        if("Y".equals(tempFlag))
        {
        		res.add("0000");
        }
        else
        {
        	res.add(errno);
        }

        logger.info("VC------------------------MOB Enquiry Child Service Test Ended WithOut ForkJoinPool------------------------VC "+refno);

		
        return res;
        
        
    }
}


























































2026-01-28 14:55:44,963 ERROR org.apache.juli.logging.DirectJDKLog [http-nio-10.243.6.75-6633-exec-1] Servlet.service() for servlet [dispatcherServlet] in context with path [] threw exception [Request processing failed; nested exception is org.springframework.beans.factory.UnsatisfiedDependencyException: Error creating bean with name 'MRE1Service': Unsatisfied dependency expressed through field 'SyscReponight'; nested exception is org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'com.tcs.bancs.microservices.repository.night.SyscDetailNightRepo' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {@org.springframework.beans.factory.annotation.Autowired(required=true)}] with root cause
|||org.springframework.beans.factory.NoSuchBeanDefinitionException: No qualifying bean of type 'com.tcs.bancs.microservices.repository.night.SyscDetailNightRepo' available: expected at least 1 bean which qualifies as autowire candidate. Dependency annotations: {@org.springframework.beans.factory.annotation.Autowired(required=true)}
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.raiseNoMatchingBeanFound(DefaultListableBeanFactory.java:1717)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.doResolveDependency(DefaultListableBeanFactory.java:1273)
	at org.springframework.beans.factory.support.DefaultListableBeanFactory.resolveDependency(DefaultListableBeanFactory.java:1227)
	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor$AutowiredFieldElement.inject(AutowiredAnnotationBeanPostProcessor.java:640)
	at org.springframework.beans.factory.annotation.InjectionMetadata.inject(InjectionMetadata.java:119)
	at org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor.postProcessProperties(AutowiredAnnotationBeanPostProcessor.java:399)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.populateBean(AbstractAutowireCapableBeanFactory.java:1420)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:593)
	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:516)
	at org.springframework.beans.factory.support.AbstractBeanFactory.lambda$doGetBean$0(AbstractBeanFactory.java:324)
	at org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:234)
	at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:322)
	at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:202)
	at org.springframework.web.method.HandlerMethod.createWithResolvedBean(HandlerMethod.java:336)
	at org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.getHandlerInternal(AbstractHandlerMethodMapping.java:368)
	at org.springframework.web.servlet.mvc.method.RequestMappingInfoHandlerMapping.getHandlerInternal(RequestMappingInfoHandlerMapping.java:110)
	at org.springframework.web.servlet.mvc.method.RequestMappingInfoHandlerMapping.getHandlerInternal(RequestMappingInfoHandlerMapping.java:59)
	at org.springframework.web.servlet.handler.AbstractHandlerMapping.getHandler(AbstractHandlerMapping.java:396)
	at org.springframework.web.servlet.DispatcherServlet.getHandler(DispatcherServlet.java:1234)
	at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1016)
	at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:943)
	at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1006)
	at org.springframework.web.servlet.FrameworkServlet.doPost(FrameworkServlet.java:909)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:652)
	at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:883)
	at javax.servlet.http.HttpServlet.service(HttpServlet.java:733)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:231)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at com.tcs.bancs.microservices.interceptor.ResponseHeaderFilter.doFilterInternal(ResponseHeaderFilter.java:25)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.boot.actuate.metrics.web.servlet.WebMvcMetricsFilter.doFilterInternal(WebMvcMetricsFilter.java:93)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)
	at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:119)
	at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:193)
	at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:166)
	at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:202)
	at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:97)
	at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:542)
	at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:143)
	at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:92)
	at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:78)
	at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:690)
	at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343)
	at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:374)
	at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:65)
	at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:868)
	at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1590)
	at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:49)
	at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)
	at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)
	at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:61)
	at java.base/java.lang.Thread.run(Thread.java:834)

	
	
	package com.tcs.bancs.microservices.repository.night;

import java.util.List;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;
import com.tcs.bancs.microservices.db.model.Sysc;
import com.tcs.bancs.microservices.db.model.Syscpk;


@Repository("SyscReponight")
public interface SyscDetailNightRepo extends JpaRepository<Sysc, Syscpk>{
	@Query(value="select /*+INDEX_ASC(SYSC SYSCPK)*/ * from SYSC where TARGET_LEVEL='01' AND REGION_NO='a' AND SYSTEM_NO='00' AND NODE_NO='01' AND REPLICA_TYPE_X='ZZ' AND REPLICA_NO='000'", nativeQuery=true)
	  public List<Sysc> findBySyscDetail();

}


package com.tcs.bancs.microservices;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
import org.springframework.boot.autoconfigure.jdbc.DataSourceTransactionManagerAutoConfiguration;
import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.web.servlet.support.SpringBootServletInitializer;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Import;
//import org.springframework.data.jpa.repository.config.EnableJpaRepositories;

import com.tcs.bancs.microservices.config.CBSDayDbConfig;
import com.tcs.bancs.microservices.config.CBSNightDbConfig;
import com.tcs.bancs.microservices.config.CBSRefDbConfig;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

@SpringBootApplication(exclude = { DataSourceAutoConfiguration.class, // HibernateJpaAutoConfiguration.class,
		DataSourceTransactionManagerAutoConfiguration.class }, scanBasePackages = "com.tcs.bancs.microservices")
@ComponentScan(basePackages = { "com.tcs.bancs.microservices", "com.tcs.bancs.microservices.config",
		"com.tcs.bancs.api", "com.tcs.bancs.microservices.interceptor", "com.tcs.bancs.microservices.api",
		"com.tcs.bancs.microservices.model", "com.tcs.bancs.microservices.util", "com.tcs.bancs.microservices",
		"com.tcs.bancs.microservices.impl", "com.tcs.bancs.microservices.repository.day",
		"com.tcs.bancs.microservices.repository.night", "com.tcs.bancs.microservices.repository.ref",
		"com.tcs.bancs.microservices.exception", "com.tcs.bancs.microservices.mappings",
		"com.tcs.bancs.microservices.model" })
@EnableSwagger2
@Import({ CBSDayDbConfig.class, CBSNightDbConfig.class, CBSRefDbConfig.class })
public class OpenBankingServicesApp extends SpringBootServletInitializer {
	private static Logger LOGGER = LoggerFactory.getLogger(OpenBankingServicesApp.class);

	public static void main(String[] args) {

		if (System.getProperty("ChannelsPropConfigPath") == null) {
			LOGGER.info(
					"Path to config property file is not set! Please set the system variable \"ChannelsPropConfigPath\" with the path to the config file.");
			LOGGER.info("Execution Finished with Error!");
		}

		SpringApplication.run(OpenBankingServicesApp.class, args);

	}

	protected SpringApplicationBuilder configure(SpringApplicationBuilder builder) {
		return builder.sources(OpenBankingServicesApp.class);
	}

}













public class MobileEnqService {
	
	Logger logger = LoggerFactory.getLogger(MobileEnqService.class);
	Connection connection;
	String errno = new String();
	String customerStatus = CacheConfig.frameworkConfigProperties.getProperty(FrameworkConstants.LOOKUP_FILES_PATH);
	Properties custStatus = PropertyLoader
			.readPropertyFile(new String(customerStatus + "/CustomerStatus.properties"));
	
	public List<String> callMOBEnquiryChild( String refno,String branchno, String tellerno, String mobno, String cifno, int requestedNumberOfRecords,DataSource dataSource,String commonArea) throws InterruptedException, ExecutionException {
		
		logger.info("VC------------------------MOB Enquiry Child Service Started WithOut ForkJoinPool------------------------VC "+refno);

		long serviceStart = System.currentTimeMillis();
		
		String lacctno = cifno == null ? "00000000000000000" : String.format("%017d", new BigInteger(cifno));
		
        int numberOfRecordsToFetch = requestedNumberOfRecords > 0 ? requestedNumberOfRecords : 60;       
        int index = 0;       
        StringBuilder allRecordsBuilder = new StringBuilder();
   	    String tempFlag = "";
        try (Connection connection = dataSource.getConnection();RunUnit run1 = new RunUnit())
        {
        	
        	long connTime =System.currentTimeMillis()-serviceStart;
        	
        	if(connTime>20)
        	{
        		
        		/* ===================== SLOW DB CONNECTION ===================== */
        		logger.warn("SLOW-DB-CONN | Ref={} | TimeMs={} ",refno,connTime);
        	}
        	else
        	{
        		/* ===================== DB CONNECTION ACQUIRED ===================== */
                logger.info(
                        "DB-CONN-ACQUIRED | Ref={} | Thread={} | ConnHash={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection)
                );
        	}
        	
        	
        
                	
            
        	  	JVMMOB jvmmob = new JVMMOB();
        	  	LsRefNo         mobref      = new LsRefNo();
            	LsBranchNo  	mobinput1	= new LsBranchNo();
            	LsTellerNo	    mobinput2	= new LsTellerNo();
                LsMobNumber 	mobinput3 	= new LsMobNumber();
                LsCustomerNo    mobinput4	= new LsCustomerNo();
                LsFunction	    mobinput5	= new LsFunction();
				
                LsPanNumber     mobinput6   = new LsPanNumber();
                LsEmail         mobinput7   = new LsEmail();
                LsRecordArea    mobinput8   = new LsRecordArea();
                LsDataOut 	    moboutput1 	= new LsDataOut();
                LsErrorMsgNo    moboutput2 	= new LsErrorMsgNo();
                LsLastCust      moboutput3 	= new LsLastCust();
                LsLastNumCuid	mobcuid		= new LsLastNumCuid();
                mobinput2.setLsTellerNo(tellerno);
                mobinput1.setLsBranchNo(String.format("%016d", Integer.parseInt(branchno)));  
                mobinput3.setLsMobNumber(mobno);
                mobinput4.setLsCustomerNo(lacctno);
                mobinput5.setLsFunction("M");
                mobinput6.setLsPanNumber("");
                mobinput7.setLsEmail("");
                mobcuid.setLsLastNumCuid("");
                mobinput8.setLsRecordArea(commonArea);
                mobref.setLsRefNo(refno);
                
               
                
//                try (RunUnit run1 = new RunUnit())
//                {
                run1.Add(jvmmob);
                
                /* ===================== COBOL START ===================== */
                long start = System.currentTimeMillis();
                logger.info(
                        "COBOL-START | Ref={} | AsyncThread={} | ConnHash={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection)
                );
                
             // Call the JVMAVBL service
                run1.Call("JVMMOB",mobref.get_Reference(), mobinput1.get_Reference(), mobinput2.get_Reference(), mobinput3.get_Reference(),mobinput6.get_Reference(),mobinput7.get_Reference(), mobinput4.get_Reference(),mobinput5.get_Reference(), moboutput1.get_Reference(), moboutput2.get_Reference(), moboutput3.get_Reference(),mobcuid.get_Reference(), mobinput8.get_Reference(),connection );
                /* ===================== COBOL END ===================== */
                logger.info(
                        "COBOL-END | Ref={} | AsyncThread={} | ConnHash={} | TimeMs={}",
                        refno,
                        Thread.currentThread().getName(),
                        System.identityHashCode(connection),
                        System.currentTimeMillis() - start
                );
         
		//} 
//                catch (Exception e) 
//        {
//			logger.info("Error in using RunUnit");
//		}
          
            
                
              if(numberOfRecordsToFetch!=0)
              {
            	  while (index < numberOfRecordsToFetch) {
                      
                      String outPutRes = moboutput1.getLsDataOutArray(index);
                      if(outPutRes==null||outPutRes.trim().isEmpty())
                      {
                      	break;
                      }
                      String lastThree = outPutRes.substring(77,80);
                      String custDesc = custStatus.getProperty(lastThree);
                      custDesc = (custDesc==null) ? " ".repeat(100) : custDesc;
                      allRecordsBuilder.append(outPutRes.substring(0, 83)+custDesc);
                      index++;
                  }
              }
              
               
            
        
       
        tempFlag = "Y";
        
        logger.info("VC------------------------Mobile Enquiry Service no of records fetched : " +index+" ------------------------VC " + refno);
    } 
        
        catch (SQLException e)
        {
        	errno = "3293";
        	tempFlag = "N";
        } 

        List<String> res = new ArrayList<>();
        res.add(allRecordsBuilder.toString()); 
        res.add(String.valueOf(index)); 
        if("Y".equals(tempFlag))
        {
        		res.add("0000");
        }
        else
        {
        	res.add(errno);
        }

        logger.info("VC------------------------MOB Enquiry Child Service Ended WithOut ForkJoinPool------------------------VC "+refno);

		
        return res;
        
        
    }
}














@RestController
@Api(value = "Aggregation_API", description = " ", tags = { "Aggregation API" })
@RequestMapping("/")
@Cacheable
@CacheEvict
public class PFMOBEnquiryService {

//////////////////////////////////////////////////////////////////////////--------ENV VARIABLES STARTED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
	
	@Autowired
	AggregationServiceImpl aggregationServiceImpl;

	@Autowired
	MigenqDetailsRepositoryImpl migDetails;
	
	@Autowired
	TelmDetailDayRepo telmRepo;
	
	
	@Autowired
	BrhmDetailDayRepo brhmRepo;
	
	@Autowired
	Ig01DetailDayRepo ig01DeatilDayRepo;
	
	@Autowired
	CrddDetailDayRepo crddDetailDayRepo;
	
	@Autowired
	DBProcess dbProcess;

	@Value("${UTENVCALS-BANCS-TRACE-STATE}")
	private String bancsTraceState;

	@Value("${UTENVCALS-MASTER-DQPTYPE}")
	private String masterDQType;

	@Value("${UTENVCALS-BANCS-HOST}")
	private String bancsHost;

	@Value("${UTENVCALS-FNS-SYSNUM}")
	private String fnsSysnum;

	@Value("${UTENVCALS-CTRL-SYSNUM}")
	private String ctrlSysnum;

	@Value("${UTENVCALS-DAY-SYSNUM}")
	private String daySysnum;

	@Value("${UTENVCALS-NIGHT-SYSNUM}")
	private String nightSysnum;

	@Value("${UTENVCALS-NON24H-SYSNUM}")
	private String non24hsum;

	@Value("${UTENVCALS-DEF-RMODE}")
	private String defRMode;

	@Value("${UTENVCALS-MASTER-DB}")
	private String masterDB;
	
	@Value("${UTENVCALS-MASTER-DB-1}")
	private String masterDB1;

	@Value("${UTENVCALS-MASTER-DB-2}")
	private String masterDB2;

	@Value("${UTENVCALS-PRMASTER-DB}")
	private String masterPRDB;
	
	@Value("${UTENVCALS-SERVICES-FLAG}")
	private String servicesFlag;

	@Value("${VC-MS-SERVICE-ID}")
	private String serviceid;
	
	@Value("${pf.response.outline.location}")
	private String PF_RES_FILE_PATH;
	
	@Value("${mob.response.outline.location}")
	private String MOB_RES_FILE_PATH;
		
	@Value("${UTENVCALS-INSPARAM-FLAG}")
	private String INSPARAM_FLAG;
	
	@Value("${UTENVCALS-INSPARAM-VALUE}")
	private String INSPARAM_VALUE;
	
	@Value("${UTENVCALS-DEF-RMODE}")
    private String dbmode;
	
	@Autowired
	@Qualifier("dayDataSource")
	private DataSource dayDataSource;
	 
	
//////////////////////////////////////////////////////////////////////////--------ENV VARIABLES ENDED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

	Logger logger = LoggerFactory.getLogger(PFMOBEnquiryService.class);
	
//////////////////////////////////////////////////////////////////////////--------PATH FILES READING STARTED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
	
	String ErrorCodeMasterFilePath = CacheConfig.frameworkConfigProperties
			.getProperty(FrameworkConstants.LOOKUP_FILES_PATH);
	Properties error = PropertyLoader
			.readPropertyFile(new String(ErrorCodeMasterFilePath + "/ErrorCodeMaster.properties"));
//////////////////////////////////////////////////////////////////////////--------PATH FILES READING ENDED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
	
	
	private final Response responseObj;

	@Autowired
	public PFMOBEnquiryService(Response responseObj) {
		
		this.responseObj = responseObj;
	}
	
	@InitBinder
	public void initBinder(WebDataBinder binder) {
		binder.setDisallowedFields(new String[] {});
	}
	
//////////////////////////////////////////////////////////////////////////-------- OBJECTS CREATION STARTED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
	
	ErrorResponse 				errobj 		= new ErrorResponse();
	Error_Description 			errdesc 	= new Error_Description();
	PFEnquiryService_Child 		pfchild 	= new PFEnquiryService_Child();
	MobileEnqService            mobchild1   = new MobileEnqService();
	PanEnqService               panchild    = new PanEnqService();
	EmailEnqService             emailchild  = new EmailEnqService();
	
	Validate_RefNum             refNum      = new Validate_RefNum();
	Validate_Teller             tellerNum   = new Validate_Teller();
	Validate_Branch             branchNum   = new Validate_Branch();
	Validate_OptionCode         optionCode  = new Validate_OptionCode();
	Validate_PFNumber           pfNum       = new Validate_PFNumber();
	Validate_MobileNumber       mobNum      = new Validate_MobileNumber();
	Validate_PanNumber          panNum      = new Validate_PanNumber();
	Validate_Email              emailId     = new Validate_Email();
	Validate_CIFNumber          cifNum      = new Validate_CIFNumber();
	Validate_RecordCount        recCount    = new Validate_RecordCount();
	Validate_LastRow            lastRow     = new Validate_LastRow();
	Gson gson = new Gson();
	
	
	
//////////////////////////////////////////////////////////////////////////-------- OBJECTS CREATION ENDED--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\


	@SuppressWarnings({ "unchecked", "rawtypes"})
	@ApiOperation(value = "Call PFMOB", notes = "PFMOB Service:This API is used to fetch Customer Details.")
	@PostMapping(value = { "/RCA_PFMOBEnq" }, produces = { "application/json" })
	@CrossOrigin()
	@JsonIgnoreProperties(ignoreUnknown = true)
	@Validated
	public ResponseEntity<Object> getCustomerDetails(@RequestBody(required = false) @Valid RequestBean_PFMOB reqbean,
			HttpServletRequest request, @RequestHeader HttpHeaders headers, HttpServletResponse response) throws Exception {
 
		
		response.setHeader("X-Content-Type-Options", "nosniff");
		response.setHeader("X-Frame-Options", "DENY");
		response.setHeader("Content-Security-Policy", "default-src 'self'");
		response.setHeader("X-XSS-Protection", "1;mode=block");
		response.setHeader("Cache-control", "no-cache,no-store");
		
//////////////////////////////////////////////////////////////////////////-------- INITIAL VARIABLES--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
		
		String IPAddress = request.getHeader("X-Forwarded-For");
		String remoteAddress = request.getRemoteAddr();
		String accept = request.getHeader("Content-Type");
		DateTimeFormatter entryDate1 = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss:SSS");
		LocalDateTime time = LocalDateTime.now();
		String entryDate = entryDate1.format(time);
		
//////////////////////////////////////////////////////////////////////////-------- SERVICE VARIABLES--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
		String reqbeanstr = new String();
		String finalResponse = new String();
		String res_file_path = new String();
		String refno = new String();
		String tellerno = new String();
		String branchno = new String();
		String option_code = new String();
		String pfno = new String();
		String noOfRecords = new String();
		String cifno = new String();
		String mobno = new String();
		String panno = new String();
		String emailid = new String();
		String chkderr = new String();
		String sourceId  = new String();
		String validChkdFlag = new String();
		List<String> chkdRes = new ArrayList<>();
		String out_response = new String();
		String errno = new String();
		String errDesc = new String();
		List<String> errList = new ArrayList<>();
		DataSource dataSource = getDataSource("day");
		List<Telm> telm = new ArrayList<Telm>();
		List<Brhm> brhm = new ArrayList<Brhm>();
		List<Ig01> signonDate = new ArrayList<Ig01>();
		List<Crdd> crdd = new ArrayList<Crdd>();
		String sigonTelmDate = new String();
		String teller_identifier = new String();
		String stat = new String();
		String sign_on_flag= new String();
		String formattedTeller = new String();
		String formattedBranch = new String();
		String formattedCardFileForCrdd =  new String();
		String formattedTellerForCrdd=  new String();
		String formatTellerRemoveZeros=  new String();		
		String Ig01date = new String();
		boolean allowTellerFlag = false;
		boolean allowBranchFlag = false;
		boolean isValidTeller = true;
//////////////////////////////////////////////////////////////////////////-------- ENV VARIABLES--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
		
		String callcode = "S";
		String opt = "";
		List<String> res = new ArrayList<String>();
		String formattedmasterDB1 = StringUtils.rightPad(masterDB1, 15);
		String formattedmasterDB2 = StringUtils.rightPad(masterDB2, 15);
		String lsRecArea = bancsTraceState.trim() + masterDQType.trim() + bancsHost.trim() + fnsSysnum.trim()
				+ ctrlSysnum.trim() + daySysnum.trim() + nightSysnum.trim() + non24hsum.trim() + defRMode.trim()
				+ formattedmasterDB1 + formattedmasterDB2 + servicesFlag.trim()+ INSPARAM_FLAG.trim() + INSPARAM_VALUE.trim();
//////////////////////////////////////////////////////////////////////////-------- INPUT VALIDATIONS--------\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
	   try {
		if(reqbean != null) {
	    	
	    	if(!reqbean.isEmpty()){
	    	reqbeanstr = gson.toJson(reqbean).toString();
	    	refno	    =  reqbean.getReferenceNumber();
	    	tellerno = reqbean.getTellerNumber();
	    	branchno = reqbean.getBranchNumber();
	    	option_code = reqbean.getOption();
		    errList  =  refNum.validateRefNum(refno);
		    logger.info("VC------------------------Successfully read application.properties------------------------VC "+refno);
		    errno = errList.get(1);
		    refno = errList.get(0);
		    if(!errno.equals("00000")) {			
		    errDesc = error.getProperty(errno);
			finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
			migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
			return new ResponseEntity(finalResponse, HttpStatus.OK);
			}

			errList = tellerNum.validateTellerNum(refno,tellerno);
		    errno = errList.get(1);
		    tellerno = errList.get(0);
			if (!errno.equals("00000")) {

				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}

			
			errList = branchNum.validateBranchNum(refno,branchno);
		    errno = errList.get(1);
		    branchno = errList.get(0);
			if (!errno.equals("00000")) {

				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
			errList = optionCode.validateOptionCode(refno,option_code);
		    errno = errList.get(1);
		    option_code = errList.get(0);
			if (!errno.equals("00000")) {

				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
			if ("F".equalsIgnoreCase(option_code)) {

				pfno = reqbean.getRequestData();
				errList = pfNum.validatePFNum(refno,pfno);
			    errno = errList.get(1);
			    pfno = errList.get(0);
				res_file_path = PF_RES_FILE_PATH;
						
				if (!errno.equals("00000")) {

					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);
				}
			
			logger.info("VC------------------------Fetched PF_RES_FILE_PATH------------------------VC "+refno);
			} else if ("M".equalsIgnoreCase(option_code)) {
				mobno = reqbean.getRequestData();
				errList = mobNum.validateMobileNum(refno,mobno);
			    errno = errList.get(1);
			    mobno = errList.get(0);
				res_file_path = MOB_RES_FILE_PATH;
						
				if (!errno.equals("00000")) {
					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);
				}
			logger.info("VC------------------------Fetched MOB_RES_FILE_PATH------------------------VC "+refno);
			} 
			else if ("P".equalsIgnoreCase(option_code)) {
				panno = reqbean.getRequestData();
				errList = panNum.validatePanNum(refno,panno);
			    errno = errList.get(1);
			    panno = errList.get(0);
				res_file_path = MOB_RES_FILE_PATH;
						
				if (!errno.equals("00000")) {
					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);
				}
			logger.info("VC------------------------Fetched PAN_RES_FILE_PATH------------------------VC "+refno);
			
			}
			 else if ("E".equalsIgnoreCase(option_code)) {
					emailid = reqbean.getRequestData();
					errList = emailId.validateEmailId(refno,emailid);
				    errno = errList.get(1);
				    emailid = errList.get(0);
					res_file_path = MOB_RES_FILE_PATH;
							
					if (!errno.equals("00000")) {
						errDesc = error.getProperty(errno);
						finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
						migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
						return new ResponseEntity(finalResponse, HttpStatus.OK);
					}
				logger.info("VC------------------------Fetched EMAIL_RES_FILE_PATH------------------------VC "+refno);
			 }
			else {
				errno = "CB426";
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}

			cifno = reqbean.getCIFNumber();
			chkdRes = cifNum.validateCIFNumber(refno,cifno);
			errno = chkdRes.get(1);
			if (!errno.equals("00000")) {
				if (errno.equals("6240")) {
					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);
				} else {
					chkderr = errno;
					validChkdFlag = "N";
				}
			} else {
				cifno = chkdRes.get(0);
				validChkdFlag = "Y";
			}
			String requestedNoOfRecords = reqbean.getRecordCount();
		    errList = recCount.validateRecordCount(refno,requestedNoOfRecords);	    
		    requestedNoOfRecords = errList.get(0);
		    errno = errList.get(1);
			if (!errno.equals("00000")) {
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
		    
		    String lastrow = reqbean.getLastRow();
		    errList = lastRow.validateLastRow(refno,lastrow);	    
		    lastrow = errList.get(0);
		    errno = errList.get(1);
			if (!errno.equals("00000")) {
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}			
			
            logger.info("VC------------------------Initiating DB Pooling------------------------VC "+refno);
			if (accept != null && accept.contains("application/json")) {
				if (validChkdFlag.equals("Y")) {
				
				logger.info(
						"VC------------------------Intiating Teller&Branch Validation------------------------VC "
								+ refno);
				ArrayList<Object> queryParamsTlr = new ArrayList<>();
				ArrayList<Object> queryParamsBrhm = new ArrayList<>();
				ArrayList<Object> queryParamsSignonDate = new ArrayList<>();
				ArrayList<Object> queryParamsCrddTeller = new ArrayList<>();
				queryParamsTlr.add("003");
				formattedTeller = StringUtils.leftPad(tellerno, 16, "0");
				queryParamsTlr.add(formattedTeller);

				formattedBranch = "003" + StringUtils.leftPad(branchno, 16, "0");
				queryParamsBrhm.add(formattedBranch);

				queryParamsSignonDate.add("000");

				// For CRDD Teller Check
				String tempString = "BYPASS_TLM.card";
				formattedCardFileForCrdd = String.format("%-30s", tempString);
				formatTellerRemoveZeros = tellerno.replaceAll("^0+(?!$)", "");
				formattedTellerForCrdd = String.format("%-299s", formatTellerRemoveZeros);

				queryParamsCrddTeller.add(formattedCardFileForCrdd);
				queryParamsCrddTeller.add(formattedTellerForCrdd);

				try {
					crdd = crddDetailDayRepo.findByCrddDetails(formattedCardFileForCrdd,formattedTellerForCrdd);
					brhm = brhmRepo.findByBrhmDetails(formattedBranch);
					signonDate = ig01DeatilDayRepo.findByIg01Details("000");
					DateTimeFormatter inputFormatter = DateTimeFormatter.ofPattern("yyyyMMdd");
					DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern("ddMMyyyy");
					LocalDate date = LocalDate.parse(signonDate.get(0).getCntldate(), inputFormatter);
					String dateStringDDMMYYYY = date.format(outputFormatter);
					Ig01date = dateStringDDMMYYYY;

				} catch (RuntimeException e1) {
					// TODO Auto-generated catch block
					logger.info("Exception Occured at CRDD and BRHM Check " + refno );
					errno = "3293";
					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);				
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);						
					}

				if (crdd != null && !crdd.isEmpty()) {

					if (formatTellerRemoveZeros.equals(crdd.get(0).getVALUE().trim())) {

						logger.info("VC------------------------Virtual Teller Based on CRDD Value Validated Sucessfully------------------------VC "+ refno);

						allowTellerFlag = true;

					}

				}

				else {

					try {
						telm = telmRepo.findByTelmDetails("003", formattedTeller);
						signonDate = ig01DeatilDayRepo.findByIg01Details("000");
						DateTimeFormatter inputFormatter = DateTimeFormatter.ofPattern("yyyyMMdd");
						LocalDate date = LocalDate.parse(signonDate.get(0).getCntldate(), inputFormatter);
						DateTimeFormatter outputFormatter = DateTimeFormatter.ofPattern("ddMMyyyy");
						String ddmmyyyy = date.format(outputFormatter);
						Ig01date = ddmmyyyy;
					} catch (RuntimeException e) {
						logger.info("Exception Occured at TELM " + refno );
						errno = "3293";
						errDesc = error.getProperty(errno);
						finalResponse = errobj.getErrorResponse(errno, errDesc, refno);				
						migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
						return new ResponseEntity(finalResponse, HttpStatus.OK);
					
					}

					if (telm != null && !telm.isEmpty()) {
						sign_on_flag = telm.get(0).getSIGNON_FLAG();
						teller_identifier = telm.get(0).getTELLER_IDENTIFIER();
						sigonTelmDate = telm.get(0).getSIGN_ON_DATE();
						stat = telm.get(0).getSTAT();
						if ("Y".equals(teller_identifier)) 
						{
							logger.info("VC------------------------Virtual Teller Based On Teller Identifier Validated Sucessfully------------------------VC "+ refno);
							allowTellerFlag = true;
						}

						else if ("Y".equals(sign_on_flag) && "01".equals(stat) && Objects.equals(sigonTelmDate, Ig01date)) {
							logger.info("VC------------------------Teller Validated Sucessfully------------------------VC "+ refno);

							allowTellerFlag = true;
						}

						else {
							allowTellerFlag = false;
						}
					}

					else {

						isValidTeller = false;
					}

				}

				if (brhm != null && !brhm.isEmpty()) {
					allowBranchFlag = true;
					logger.info("VC-------------- Branch Validated Sucessfully --------------VC "+refno);
					
				} else {
					allowBranchFlag = false;
				}

				if (isValidTeller)
				{
					if (allowTellerFlag)
					{
						if (allowBranchFlag) 
						{
							 
							 logger.info("VC------------------------Region Mode check ended------------------------VC "+ refno);
							 if ("F".equalsIgnoreCase(option_code)) {

									logger.info(
											"VC------------------------Validated PF Option_Code------------------------VC "+refno);
									res = pfchild.callPFEnquiryChild(refno,branchno, tellerno, pfno, cifno, Integer.parseInt(requestedNoOfRecords), lastrow,dataSource,lsRecArea);
									out_response = res.get(0);
									noOfRecords = res.get(1);
									
									logger.info("VC------------------------Fetched NO_OF_RECORDS------------------------VC " + noOfRecords);
									errno = res.get(2);
									
									logger.info("VC------------------------Fetched ERROR_NUMBER------------------------VC " + errno);

								} else if ("M".equalsIgnoreCase(option_code)) {
									logger.info(
											"VC------------------------Validated Mobile Option_Code------------------------VC " + refno);

									res = mobchild1.callMOBEnquiryChild(refno, branchno, tellerno, mobno, cifno, Integer.parseInt(requestedNoOfRecords),dataSource,lsRecArea);
									out_response = res.get(0);
									noOfRecords = res.get(1);
									logger.info("VC------------------------Fetched NO_OF_RECORDS------------------------VC " + noOfRecords);
									errno = res.get(2);
									logger.info("VC------------------------Fetched ERROR_NUMBER------------------------VC " + errno);
									
								}
								else if ("P".equalsIgnoreCase(option_code)) {
									logger.info(
											"VC------------------------Validated PAN Option_Code------------------------VC "+refno);

									res = panchild.callPANEnquiryChild(refno ,branchno, tellerno, panno, cifno, Integer.parseInt(requestedNoOfRecords),dataSource,lsRecArea);
									out_response = res.get(0);
									noOfRecords = res.get(1);
									logger.info("VC------------------------Fetched NO_OF_RECORDS------------------------VC " + noOfRecords);
									errno = res.get(2);
									logger.info("VC------------------------Fetched ERROR_NUMBER------------------------VC " + errno);
									
								}
								else if("E".equalsIgnoreCase(option_code)) {
									logger.info(
											"VC------------------------Validated EmailID Option_Code------------------------VC "+refno);

									res = emailchild.callEMAILEnquiryChild(refno,branchno, tellerno, emailid, cifno, Integer.parseInt(requestedNoOfRecords),dataSource,lsRecArea);
									out_response = res.get(0);
									noOfRecords = res.get(1);
									logger.info("VC------------------------Fetched NO_OF_RECORDS------------------------VC " + noOfRecords);
									errno = res.get(2);
									logger.info("VC------------------------Fetched ERROR_NUMBER------------------------VC " + errno);
									
								}
						}
						else
						{
							
								 logger.info("VC--------------INVALID BRANCH NUMBER--------------VC "+refno);
								 errno = "0526";
								 errDesc = error.getProperty(errno);
								 finalResponse =errobj.getErrorResponse(errno, errDesc, refno);
								 migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.
								 toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate,
								 IPAddress, errno, errDesc, "1",
								 Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
								 return new ResponseEntity(finalResponse, HttpStatus.OK); 
								 
						}
								 			 
						
					} else {
						
						 logger.info("VC--------------USER NOT SIGNED ON--------------VC "+refno);
						 errno = "0148"; 
						 errDesc = error.getProperty(errno);
						 finalResponse =errobj.getErrorResponse(errno, errDesc, refno);
						 migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.
						 toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate,
						 IPAddress, errno, errDesc, "1",
						 Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
						 return new ResponseEntity(finalResponse, HttpStatus.OK);
						
					}
				} else {
					logger.info("VC--------------INVALID TELLER NUMBER--------------VC " + refno);
					errno = "0529";
					errDesc = error.getProperty(errno);
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(
							Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()),
							remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1",
							Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure");
					return new ResponseEntity(finalResponse, HttpStatus.OK);
				}

			}
				else {
					  errno = chkderr;
					  try(Connection connection = dataSource.getConnection()) {	
							errDesc = errdesc.getCbsErrDesc(chkderr, callcode, opt, lsRecArea, connection);
							}
					  catch(SQLException e) {
						    errno = "3293";
							errDesc = error.getProperty(errno);
							finalResponse = errobj.getErrorResponse(errno, errDesc, refno);				
							migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
							return new ResponseEntity(finalResponse, HttpStatus.OK);
					  }
					  finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
						migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					  return new ResponseEntity(finalResponse, HttpStatus.OK);
				  }
				
			}

			else {
				errno = "0435";
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);			
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
	    }
	    	else {
	    		errno = "CB422";
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((" ".toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
	    	}
	    }
	
	    	else {
	    		errno = "CB422";
				errDesc = error.getProperty(errno);
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((" ".toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
		
		
		
	
	    logger.info("VC------------------------BEFORE GETTING RESPONSE------------------------VC "+refno);
	    
		if (errno.equals("0000") || (errno.equals("0868") && !out_response.trim().isEmpty()) || (errno.equals("0188") && !out_response.trim().isEmpty())) {
			errno = "";
			finalResponse = responseObj.getResponse(res_file_path, out_response, refno, noOfRecords);
 			migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "0", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "success" );
		}else if(errno.equals("3293"))
		{
			    errDesc = error.getProperty(errno);			
				finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
				migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
				return new ResponseEntity(finalResponse, HttpStatus.OK);
		}
		else {
			try(Connection connection = dataSource.getConnection()) {
			errDesc = errdesc.getCbsErrDesc(errno, callcode, opt, lsRecArea,connection);
			}
		 catch(SQLException e1) 
			{
			        errno = "3293";
				    errDesc = error.getProperty(errno);		
					finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
					migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
					return new ResponseEntity(finalResponse, HttpStatus.OK);
			}
			finalResponse = errobj.getErrorResponse(errno, errDesc, refno);
			migDetails.saveToLogDB(Base64.getEncoder().encodeToString((reqbeanstr.toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
			return new ResponseEntity(finalResponse, HttpStatus.OK);
		}
		
		
	} catch(Exception  ex) {
		logger.info("EXCEPTION OCCURED IN PFMOB ENQUIRY " +" " + refno);
		errno = "0155";
		errDesc = error.getProperty(errno);
		finalResponse = errobj.getErrorResponse(errno, errDesc, refno);	
		migDetails.saveToLogDB(Base64.getEncoder().encodeToString((" ".toString()).getBytes()), remoteAddress, tellerno, refno, sourceId, entryDate, IPAddress, errno, errDesc, "1", Base64.getEncoder().encodeToString((finalResponse).getBytes()), "failure" );
		return new ResponseEntity(finalResponse, HttpStatus.OK);
	}
	   return new ResponseEntity(finalResponse, HttpStatus.OK); 
	}   
private DataSource getDataSource(String dbType) {
    switch (dbType) {
        case "day":
            return dayDataSource;
        default:
            throw new IllegalArgumentException("Unsupported database type: " + dbType);
    }
}
}







